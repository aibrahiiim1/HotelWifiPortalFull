@{
    ViewData["Title"] = "RADIUS Settings";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    
    var radiusMode = ViewBag.RadiusMode ?? "builtin";
    var builtinEnabled = ViewBag.BuiltinEnabled ?? true;
    var freeRadiusEnabled = ViewBag.FreeRadiusEnabled ?? false;
    var sharedSecret = ViewBag.SharedSecret ?? "";
    var authPort = ViewBag.AuthPort ?? 1812;
    var acctPort = ViewBag.AcctPort ?? 1813;
    var coaPort = ViewBag.CoAPort ?? 3799;
    var freeRadiusConnection = ViewBag.FreeRadiusConnection ?? "";
    var tablePrefix = ViewBag.TablePrefix ?? "rad";
}

<div class="row">
    <div class="col-lg-8">
        <!-- RADIUS Mode Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-shield-check me-2"></i>RADIUS Server Mode
            </div>
            <div class="card-body">
                <form asp-action="RadiusSaveMode" method="post">
                    @Html.AntiForgeryToken()
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check card p-3 @(radiusMode == "builtin" ? "border-primary bg-light" : "")">
                                <input class="form-check-input" type="radio" name="RadiusMode" id="modeBuiltin" value="builtin" @(radiusMode == "builtin" ? "checked" : "")>
                                <label class="form-check-label" for="modeBuiltin">
                                    <h6 class="mb-1"><i class="bi bi-box me-2"></i>Built-in RADIUS Server</h6>
                                    <small class="text-muted">
                                        RADIUS server runs inside your application. Simple setup, no external dependencies.
                                    </small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check card p-3 @(radiusMode == "freeradius" ? "border-primary bg-light" : "")">
                                <input class="form-check-input" type="radio" name="RadiusMode" id="modeFreeRadius" value="freeradius" @(radiusMode == "freeradius" ? "checked" : "")>
                                <label class="form-check-label" for="modeFreeRadius">
                                    <h6 class="mb-1"><i class="bi bi-server me-2"></i>FreeRADIUS (External)</h6>
                                    <small class="text-muted">
                                        Use external FreeRADIUS server. More scalable, industry standard.
                                    </small>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Save Mode
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Built-in RADIUS Settings -->
        <div class="card mb-4" id="builtinSettings">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-box me-2"></i>Built-in RADIUS Server Settings</span>
                <span class="badge @(builtinEnabled ? "bg-success" : "bg-secondary")">
                    @(builtinEnabled ? "Active" : "Inactive")
                </span>
            </div>
            <div class="card-body">
                <form asp-action="RadiusSaveBuiltin" method="post">
                    @Html.AntiForgeryToken()
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Shared Secret *</label>
                            <div class="input-group">
                                <input type="password" name="SharedSecret" id="sharedSecret" class="form-control" value="@sharedSecret" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('sharedSecret')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="generateSecret()">
                                    <i class="bi bi-shuffle"></i>Generate
                                </button>
                            </div>
                            <small class="text-muted">Must match the secret configured on MikroTik/NAS</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Authentication Port</label>
                            <input type="number" name="AuthPort" class="form-control" value="@authPort">
                            <small class="text-muted">Default: 1812</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Accounting Port</label>
                            <input type="number" name="AcctPort" class="form-control" value="@acctPort">
                            <small class="text-muted">Default: 1813</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CoA/Disconnect Port</label>
                            <input type="number" name="CoAPort" class="form-control" value="@coaPort">
                            <small class="text-muted">Default: 3799</small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Save Settings
                    </button>
                </form>
            </div>
        </div>

        <!-- FreeRADIUS Settings -->
        <div class="card mb-4" id="freeradiusSettings">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-server me-2"></i>FreeRADIUS Integration Settings</span>
                <span class="badge @(freeRadiusEnabled ? "bg-success" : "bg-secondary")">
                    @(freeRadiusEnabled ? "Enabled" : "Disabled")
                </span>
            </div>
            <div class="card-body">
                <form asp-action="RadiusSaveFreeRadius" method="post">
                    @Html.AntiForgeryToken()

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="FreeRadiusEnabled" id="freeRadiusEnabled" @(freeRadiusEnabled ? "checked" : "")>
                            <label class="form-check-label" for="freeRadiusEnabled">Enable FreeRADIUS Integration</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">MySQL/MariaDB Connection String *</label>
                        <input type="text" name="ConnectionString" class="form-control font-monospace" value="@freeRadiusConnection" placeholder="Server=localhost;Database=radius;User=radius;Password=radpass;">
                        <small class="text-muted">Connection to FreeRADIUS database</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Table Prefix</label>
                            <input type="text" name="TablePrefix" class="form-control" value="@tablePrefix" placeholder="rad">
                            <small class="text-muted">Prefix for RADIUS tables (radcheck, radreply, etc.)</small>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Save Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="testFreeRadiusConnection()">
                            <i class="bi bi-plug me-1"></i>Test Connection
                        </button>
                        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#sqlSchemaModal">
                            <i class="bi bi-file-code me-1"></i>View SQL Schema
                        </button>
                        <a href="@Url.Action("FreeRadius")" class="btn btn-outline-warning">
                            <i class="bi bi-tools me-1"></i>Advanced Management
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-activity me-2"></i>RADIUS Status
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="rounded-circle bg-success p-2 me-3">
                        <i class="bi bi-broadcast text-white"></i>
                    </div>
                    <div>
                        <small class="text-muted">Server Status</small>
                        <p class="mb-0 fw-bold text-success">Running</p>
                    </div>
                </div>
                <hr>
                <dl class="mb-0">
                    <dt>Auth Requests Today</dt>
                    <dd>@(ViewBag.AuthRequests ?? 0)</dd>
                    <dt>Successful Auths</dt>
                    <dd>@(ViewBag.SuccessfulAuths ?? 0)</dd>
                    <dt>Failed Auths</dt>
                    <dd>@(ViewBag.FailedAuths ?? 0)</dd>
                </dl>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning me-2"></i>Quick Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <form asp-action="RadiusSyncUsers" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="bi bi-arrow-repeat me-1"></i>Sync All Users
                        </button>
                    </form>
                    <form asp-action="RadiusSyncProfiles" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-sliders me-1"></i>Sync Bandwidth Profiles
                        </button>
                    </form>
                    <a href="/Admin/Logs/Index?category=RADIUS" class="btn btn-outline-info w-100">
                        <i class="bi bi-journal-text me-1"></i>View RADIUS Logs
                    </a>
                </div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-question-circle me-2"></i>Help
            </div>
            <div class="card-body">
                <h6>Which mode should I use?</h6>
                <p class="small text-muted">
                    <strong>Built-in RADIUS:</strong> Best for small to medium deployments. Easy setup, runs inside your app.
                </p>
                <p class="small text-muted">
                    <strong>FreeRADIUS:</strong> Best for large deployments or when you need advanced features like failover, load balancing, or integration with other systems.
                </p>
                <hr>
                <h6>MikroTik Configuration</h6>
                <p class="small text-muted mb-1">Point your MikroTik RADIUS client to:</p>
                <code class="d-block small bg-light p-2 rounded">
                    Server: YOUR_SERVER_IP<br>
                    Auth Port: @authPort<br>
                    Acct Port: @acctPort<br>
                    Secret: (as configured)
                </code>
            </div>
        </div>
    </div>
</div>

<!-- SQL Schema Modal -->
<div class="modal fade" id="sqlSchemaModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-code me-2"></i>FreeRADIUS SQL Schema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Run this SQL on your FreeRADIUS database (MySQL/MariaDB):</p>
                <pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;"><code id="sqlSchema">@ViewBag.SqlSchema</code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="copySqlSchema()">
                    <i class="bi bi-clipboard me-1"></i>Copy to Clipboard
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function togglePassword(inputId) {
        var input = document.getElementById(inputId);
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    function generateSecret() {
        var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@@#$%^&*';
        var secret = '';
        for (var i = 0; i < 24; i++) {
            secret += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('sharedSecret').value = secret;
        document.getElementById('sharedSecret').type = 'text';
    }

    function copySqlSchema() {
        var schema = document.getElementById('sqlSchema').textContent;
        navigator.clipboard.writeText(schema).then(function() {
            alert('SQL schema copied to clipboard!');
        });
    }

    function testFreeRadiusConnection() {
        alert('Testing FreeRADIUS connection... (implement AJAX call)');
    }

    // Toggle settings visibility based on mode
    document.querySelectorAll('input[name="RadiusMode"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            var mode = this.value;
            document.getElementById('builtinSettings').style.opacity = mode === 'builtin' ? '1' : '0.5';
            document.getElementById('freeradiusSettings').style.opacity = mode === 'freeradius' ? '1' : '0.5';
        });
    });
</script>
}
